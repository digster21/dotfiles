#!/usr/bin/env sh

[ -n "$SHELLRC_GUARD" ] && return
SHELLRC_GUARD=1

add_PATH() {
    local debug=false
    local dry_run=false
    local arg=""

    while [ $# -gt 0 ]; do
        case "$1" in
            --debug) debug=true ;;
            --dry-run)  dry_run=true; debug=true ;;
            *)          arg="$1" ;;
        esac
        shift
    done

    [ -z "$arg" ] && { echo "no path arg"; return 1; }

    case ":$PATH:" in
        *":$arg:"*)
            $debug && echo "duplicate >> $arg"
            return 0
            ;;
    esac

    if $dry_run; then
        echo "PATH update (dry-run) >> $arg:$PATH"
        return 0
    fi

    PATH="$arg:$PATH"
    $debug && echo "PATH update >> $PATH"
}

# Add Editor preference
if command -v nvim >/dev/null 2>&1; then
    EDITOR=nvim
elif command -v vim >/dev/null 2>&1; then
    EDITOR=vim
else
    EDITOR=vi
fi
export EDITOR

# Add Pager preference
if command -v less >/dev/null 2>&1; then
    export LESS='-F -X -R'
    PAGER=less
else
    PAGER=more
fi
export PAGER

# Configure history
HISTSIZE=3000
HISTFILESIZE=3000
HISTCONTROL=ignoreboth

if [ -n "$BASH_VERSION" ]; then
    shopt -s histappend
fi

if [ -n "$ZSH_VERSION" ]; then
    setopt APPEND_HISTORY
fi

# NVM bootstrap
NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "$HOME/.nvm" || printf %s "$XDG_CONFIG_HOME/nvm")"
if [ ! -d "$NVM_DIR" ] || [ -z "$(ls -A "$NVM_DIR" 2>/dev/null)" ]; then
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
fi
export NVM_DIR="$NVM_DIR"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
if ! nvm version 'lts/*' >/dev/null 2>&1; then
    nvm install --lts
    nvm alias default 'lts/*'
fi

add_PATH "$HOME/bin"
